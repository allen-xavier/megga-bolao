services:
  db:
    image: postgres:16-alpine
    environment:
      POSTGRES_USER: megga
      POSTGRES_PASSWORD: PgPW_9tqL2sV5mX8rJ1c
      POSTGRES_DB: megga_bolao
      TZ: America/Sao_Paulo
    volumes:
      - db_data:/var/lib/postgresql/data
    networks:
      - internal
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U $$POSTGRES_USER -d $$POSTGRES_DB"]
      interval: 10s
      timeout: 5s
      retries: 10
    deploy:
      mode: replicated
      replicas: 1
      restart_policy:
        condition: on-failure
      placement:
        constraints:
          - node.role == manager

  redis:
    image: redis:7-alpine
    command: ["redis-server", "--appendonly", "yes"]
    environment:
      TZ: America/Sao_Paulo
    volumes:
      - redis_data:/data
    networks:
      - internal
    deploy:
      mode: replicated
      replicas: 1
      restart_policy:
        condition: on-failure
      placement:
        constraints:
          - node.role == manager

  backend:
    image: ghcr.io/allen-xavier/megga-bolao-backend:latest
    environment:
      DATABASE_URL: postgresql://megga:PgPW_9tqL2sV5mX8rJ1c@db:5432/megga_bolao?schema=public
      REDIS_URL: redis://redis:6379
      WEB_ORIGIN: https://app.allentiomolu.com.br
      JWT_SECRET: jwtsec_D2c9L1mR0zVn8Qp4Xk5aS7wT3uY6hJ0b
      JWT_REFRESH_SECRET: jwtref_A7m9Q1t6V4p2Z8k3s5R0xN1yW6gH4dC
      ACCESS_TOKEN_TTL: 900
      REFRESH_TOKEN_TTL: 604800
      EVOLUTION_API_URL: https://sua-api-evolution.exemplo
      EVOLUTION_API_TOKEN: evo_tok_v73ZpL9qR2sX6uB4tM1nY8c
      SUITPAY_API_URL: https://api.suitpay.com.br
      SUITPAY_API_TOKEN: suitpay_tok_R5t8L1k2Q9sW4vH3mZ7nC0a
      SUITPAY_WEBHOOK_SECRET: suitpay_wh_84nQf2jX6mPs9yT3vZw0Lc
      PORT: 3001
      TZ: America/Sao_Paulo
    volumes:
      - backend_storage:/app/storage
    networks:
      - internal
    deploy:
      mode: replicated
      replicas: 1
      restart_policy:
        condition: on-failure

  frontend:
    image: ghcr.io/allen-xavier/megga-bolao-frontend:latest
    environment:
      NEXT_PUBLIC_API_BASE: https://app.allentiomolu.com.br/api
      NEXTAUTH_URL: https://app.allentiomolu.com.br
      NEXTAUTH_SECRET: nextauth_9rP6wJ3yV8uL2cQ4sT7gZ1mB5hF0xDa
      TZ: America/Sao_Paulo
    networks:
      - internal
    deploy:
      mode: replicated
      replicas: 1
      restart_policy:
        condition: on-failure

  nginx:
    image: nginx:alpine
    configs:
      - source: nginx_conf
        target: /etc/nginx/nginx.conf
    environment:
      TZ: America/Sao_Paulo
    networks:
      - internal
      - traefik
    deploy:
      mode: replicated
      replicas: 1
      restart_policy:
        condition: on-failure
      labels:
        - traefik.enable=true
        - traefik.docker.network=traefik-public
        - traefik.http.routers.megga.rule=Host(`app.allentiomolu.com.br`)
        - traefik.http.routers.megga.entrypoints=websecure
        - traefik.http.routers.megga.tls=true
        - traefik.http.routers.megga.tls.certresolver=letsencrypt
        - traefik.http.services.megga.loadbalancer.server.port=80

networks:
  internal:
    driver: overlay
    attachable: true
  traefik:
    external: true
    name: traefik-public

volumes:
  db_data:
    driver: local
  redis_data:
    driver: local
  backend_storage:
    driver: local

configs:
  nginx_conf:
    external: true
    name: nginx_conf
