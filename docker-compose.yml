services:
  db:
    image: postgres:16-alpine
    environment:
      POSTGRES_USER: ${POSTGRES_USER:-megga}
      POSTGRES_PASSWORD: ${POSTGRES_PASSWORD:-megga}
      POSTGRES_DB: ${POSTGRES_DB:-megga_bolao}
      TZ: America/Sao_Paulo
    volumes:
      - db_data:/var/lib/postgresql/data
    networks:
      - internal
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U $$POSTGRES_USER -d $$POSTGRES_DB"]
      interval: 10s
      timeout: 5s
      retries: 10
    deploy:
      mode: replicated
      replicas: 1
      restart_policy:
        condition: on-failure
      placement:
        constraints:
          - node.role == manager

  redis:
    image: redis:7-alpine
    command: ["redis-server", "--appendonly", "yes"]
    environment:
      TZ: America/Sao_Paulo
    volumes:
      - redis_data:/data
    networks:
      - internal
    deploy:
      mode: replicated
      replicas: 1
      restart_policy:
        condition: on-failure
      placement:
        constraints:
          - node.role == manager

  backend:
    image: ${BACKEND_IMAGE:-ghcr.io/allen-xavier/megga-bolao-backend:latest}
    environment:
      DATABASE_URL: ${DATABASE_URL:-postgresql://${POSTGRES_USER:-megga}:${POSTGRES_PASSWORD:-megga}@db:5432/${POSTGRES_DB:-megga_bolao}?schema=public}
      REDIS_URL: ${REDIS_URL:-redis://redis:6379}
      WEB_ORIGIN: ${WEB_ORIGIN:-https://app.allentiomolu.com.br}
      PORT: 3001
      TZ: America/Sao_Paulo
    volumes:
      - backend_storage:/app/storage
    networks:
      - internal
    deploy:
      mode: replicated
      replicas: 1
      restart_policy:
        condition: on-failure

  frontend:
    image: ${FRONTEND_IMAGE:-ghcr.io/allen-xavier/megga-bolao-frontend:latest}
    environment:
      NEXT_PUBLIC_API_BASE: ${NEXT_PUBLIC_API_BASE:-https://app.allentiomolu.com.br/api}
      NEXTAUTH_URL: ${NEXTAUTH_URL:-https://app.allentiomolu.com.br}
      TZ: America/Sao_Paulo
    networks:
      - internal
    deploy:
      mode: replicated
      replicas: 1
      restart_policy:
        condition: on-failure

  nginx:
    image: nginx:alpine
    configs:
      - source: nginx_conf
        target: /etc/nginx/nginx.conf
    environment:
      TZ: America/Sao_Paulo
    networks:
      - internal
      - traefik
    deploy:
      mode: replicated
      replicas: 1
      restart_policy:
        condition: on-failure
      labels:
        - traefik.enable=true
        - traefik.docker.network=traefik-public
        - traefik.http.routers.megga.rule=Host(`${APP_DOMAIN:-app.allentiomolu.com.br}`)
        - traefik.http.routers.megga.entrypoints=websecure
        - traefik.http.routers.megga.tls=true
        - traefik.http.routers.megga.tls.certresolver=${TRAEFIK_CERT_RESOLVER:-letsencrypt}
        - traefik.http.services.megga.loadbalancer.server.port=80

networks:
  internal:
    driver: overlay
    attachable: true
  traefik:
    external: true
    name: traefik-public

volumes:
  db_data:
    driver: local
  redis_data:
    driver: local
  backend_storage:
    driver: local

configs:
  nginx_conf:
    external: true
    name: nginx_conf
