datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

generator client {
  provider = "prisma-client-js"
}

enum UserRole {
  ADMIN
  SUPERVISOR
  USER
}

enum PrizeType {
  PE_QUENTE
  PE_FRIO
  CONSOLACAO
  SENA_PRIMEIRO
  LIGEIRINHO
  OITO_ACERTOS
  INDICACAO_DIRETA
  INDICACAO_INDIRETA
}

enum PaymentType {
  DEPOSIT
  WITHDRAW
  COMMISSION
  PRIZE
}

enum PaymentStatus {
  PENDING
  PROCESSING
  COMPLETED
  FAILED
  CANCELED
}

model User {
  id             String     @id @default(cuid())
  fullName       String
  phone          String     @unique
  email          String?    @unique
  cpf            String     @unique
  cep            String
  address        String
  city           String
  state          String
  pixKey         String
  passwordHash   String
  role           UserRole   @default(USER)
  acceptedTerms  Boolean    @default(false)
  createdAt      DateTime   @default(now())
  updatedAt      DateTime   @updatedAt
  referralCode   String     @unique
  wallet         Wallet?
  bets           Bet[]
  payments       Payment[]
  createdBoloes  Bolao[]    @relation("BolaoCreator")
  createdDraws   Draw[]     @relation("DrawCreator")
  auditLogs      AuditLog[]
  referrals      Referral[] @relation("UserReferrals")
  invitedRefs    Referral[] @relation("UserInvited")
  prizeWins      PrizeResultWinner[]
}

model Wallet {
  id        String   @id @default(cuid())
  user      User     @relation(fields: [userId], references: [id])
  userId    String   @unique
  balance   Decimal  @default(0.0) @db.Decimal(12, 2)
  locked    Decimal  @default(0.0) @db.Decimal(12, 2)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  statements WalletStatement[]
}

model WalletStatement {
  id          String        @id @default(cuid())
  wallet      Wallet        @relation(fields: [walletId], references: [id])
  walletId    String
  type        PaymentType
  amount      Decimal       @db.Decimal(12, 2)
  description String
  referenceId String?
  createdAt   DateTime      @default(now())
}

model Bolao {
  id                String             @id @default(cuid())
  name              String
  startsAt          DateTime
  ticketPrice       Decimal            @db.Decimal(12, 2)
  minimumQuotas     Int
  guaranteedPrize   Decimal?           @default(0.0) @db.Decimal(12, 2)
  commissionPercent Decimal            @default(0.0) @db.Decimal(5, 2)
  promotional       Boolean            @default(false)
  createdBy         User               @relation("BolaoCreator", fields: [createdById], references: [id])
  createdById       String
  prizes            Prize[]
  bets              Bet[]
  draws             Draw[]
  bolaoResults      BolaoResult[]
  transparency      TransparencyFile?
  senaPotReserved   Decimal            @default(0) @db.Decimal(12, 2)
  senaPotRolled     Decimal            @default(0) @db.Decimal(12, 2)
  createdAt         DateTime           @default(now())
  updatedAt         DateTime           @updatedAt
  closedAt          DateTime?
}

model Prize {
  id            String    @id @default(cuid())
  bolao         Bolao     @relation(fields: [bolaoId], references: [id])
  bolaoId       String
  type          PrizeType
  percentage    Decimal   @default(0.0) @db.Decimal(5, 2)
  fixedValue    Decimal?  @default(0.0) @db.Decimal(12, 2)
  maxWinners    Int?
  createdAt     DateTime  @default(now())
}

model Draw {
  id          String   @id @default(cuid())
  drawnAt     DateTime
  numbers     Int[]
  bolao       Bolao?   @relation(fields: [bolaoId], references: [id])
  bolaoId     String?
  createdBy   User     @relation("DrawCreator", fields: [createdById], references: [id])
  createdById String
  createdAt   DateTime @default(now())
}

model Bet {
  id             String    @id @default(cuid())
  user           User      @relation(fields: [userId], references: [id])
  userId         String
  bolao          Bolao     @relation(fields: [bolaoId], references: [id])
  bolaoId        String
  numbers        Int[]
  isSurprise     Boolean   @default(false)
  createdAt      DateTime  @default(now())
  transparency   TransparencyFile? @relation(fields: [transparencyId], references: [id])
  transparencyId String?
  prizeWinners   PrizeResultWinner[]
}

model TransparencyFile {
  id        String   @id @default(cuid())
  bolao     Bolao    @relation(fields: [bolaoId], references: [id])
  bolaoId   String   @unique
  filePath  String
  createdAt DateTime @default(now())
  bets      Bet[]
}

model Payment {
  id          String        @id @default(cuid())
  user        User          @relation(fields: [userId], references: [id])
  userId      String
  amount      Decimal       @db.Decimal(12, 2)
  type        PaymentType
  status      PaymentStatus @default(PENDING)
  metadata    Json?
  createdAt   DateTime      @default(now())
  processedAt DateTime?
  approvedBy  String?
}

model BolaoResult {
  id        String   @id @default(cuid())
  bolao     Bolao    @relation(fields: [bolaoId], references: [id])
  bolaoId   String
  closedAt  DateTime
  createdAt DateTime @default(now())
  prizes    PrizeResult[]
}

model PrizeResult {
  id          String           @id @default(cuid())
  bolaoResult BolaoResult      @relation(fields: [bolaoResultId], references: [id])
  bolaoResultId String
  prizeType   PrizeType
  totalValue  Decimal          @db.Decimal(12, 2)
  winners     PrizeResultWinner[]
  createdAt   DateTime         @default(now())
}

model PrizeResultWinner {
  id             String       @id @default(cuid())
  prizeResult    PrizeResult  @relation(fields: [prizeResultId], references: [id])
  prizeResultId  String
  bet            Bet          @relation(fields: [betId], references: [id])
  betId          String
  user           User         @relation(fields: [userId], references: [id])
  userId         String
  amount         Decimal      @db.Decimal(12, 2)
  hits           Int          @default(0)
  createdAt      DateTime     @default(now())
}

model SenaPot {
  id     String  @id @default("global")
  amount Decimal @default(0) @db.Decimal(12, 2)
}

model GeneralConfig {
  id                 String   @id @default("global")
  senaRollPercent    Decimal  @default(10.0) @db.Decimal(5, 2)
  defaultPrizeConfig Json?
  createdAt          DateTime @default(now())
  updatedAt          DateTime @updatedAt
}

model AffiliateConfig {
  id                String   @id @default("global")
  firstLevelPercent Decimal  @default(2.0) @db.Decimal(5, 2)
  secondLevelPercent Decimal @default(1.0) @db.Decimal(5, 2)
  firstBetBonus     Decimal  @default(0.0) @db.Decimal(12, 2)
  firstBetBonusEnabled Boolean @default(false)
  updatedAt         DateTime @updatedAt
}

model Referral {
  id             String   @id @default(cuid())
  user           User     @relation("UserReferrals", fields: [userId], references: [id])
  userId         String
  referredUser   User     @relation("UserInvited", fields: [referredUserId], references: [id])
  referredUserId String
  level          Int
  createdAt      DateTime @default(now())

  @@unique([referredUserId, level])
}

model AuditLog {
  id        String   @id @default(cuid())
  user      User?    @relation(fields: [userId], references: [id])
  userId    String?
  action    String
  details   Json?
  createdAt DateTime @default(now())
}

model SuitpayConfig {
  id             String   @id @default("current")
  environment    String   @default("sandbox")
  apiUrl         String
  clientId       String
  clientSecret   String
  webhookSecret  String?
  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt
}

model Policy {
  key       String   @id
  title     String
  content   String   @db.Text
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}
