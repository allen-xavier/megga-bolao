datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

generator client {
  provider = "prisma-client-js"
}

enum UserRole {
  ADMIN
  SUPERVISOR
  USER
}

enum PrizeType {
  PE_QUENTE
  PE_FRIO
  CONSOLACAO
  SENA_PRIMEIRO
  LIGEIRINHO
  OITO_ACERTOS
  INDICACAO_DIRETA
  INDICACAO_INDIRETA
}

enum PaymentType {
  DEPOSIT
  WITHDRAW
  COMMISSION
  PRIZE
}

enum PaymentStatus {
  PENDING
  PROCESSING
  COMPLETED
  FAILED
  CANCELED
}

model User {
  id             String     @id @default(cuid())
  fullName       String
  phone          String     @unique
  email          String?    @unique
  cpf            String     @unique
  cep            String
  address        String
  city           String
  state          String
  pixKey         String
  passwordHash   String
  role           UserRole   @default(USER)
  acceptedTerms  Boolean    @default(false)
  createdAt      DateTime   @default(now())
  updatedAt      DateTime   @updatedAt
  wallet         Wallet?
  bets           Bet[]
  payments       Payment[]
  createdBoloes  Bolao[]    @relation("BolaoCreator")
  createdDraws   Draw[]     @relation("DrawCreator")
  auditLogs      AuditLog[]
  referrals      Referral[] @relation("UserReferrals")
  invitedRefs    Referral[] @relation("UserInvited")
}

model Wallet {
  id        String   @id @default(cuid())
  user      User     @relation(fields: [userId], references: [id])
  userId    String   @unique
  balance   Decimal  @default(0.0) @db.Decimal(12, 2)
  locked    Decimal  @default(0.0) @db.Decimal(12, 2)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  statements WalletStatement[]
}

model WalletStatement {
  id          String        @id @default(cuid())
  wallet      Wallet        @relation(fields: [walletId], references: [id])
  walletId    String
  type        PaymentType
  amount      Decimal       @db.Decimal(12, 2)
  description String
  referenceId String?
  createdAt   DateTime      @default(now())
}

model Bolao {
  id                String             @id @default(cuid())
  name              String
  startsAt          DateTime
  ticketPrice       Decimal            @db.Decimal(12, 2)
  minimumQuotas     Int
  guaranteedPrize   Decimal?           @default(0.0) @db.Decimal(12, 2)
  commissionPercent Decimal            @default(0.0) @db.Decimal(5, 2)
  promotional       Boolean            @default(false)
  createdBy         User               @relation("BolaoCreator", fields: [createdById], references: [id])
  createdById       String
  prizes            Prize[]
  bets              Bet[]
  transparency      TransparencyFile?
  createdAt         DateTime           @default(now())
  updatedAt         DateTime           @updatedAt
  closedAt          DateTime?
}

model Prize {
  id            String    @id @default(cuid())
  bolao         Bolao     @relation(fields: [bolaoId], references: [id])
  bolaoId       String
  type          PrizeType
  percentage    Decimal   @default(0.0) @db.Decimal(5, 2)
  fixedValue    Decimal?  @default(0.0) @db.Decimal(12, 2)
  maxWinners    Int?
  createdAt     DateTime  @default(now())
}

model Draw {
  id          String   @id @default(cuid())
  drawnAt     DateTime
  numbers     Int[]
  createdBy   User     @relation("DrawCreator", fields: [createdById], references: [id])
  createdById String
  createdAt   DateTime @default(now())
}

model Bet {
  id             String    @id @default(cuid())
  user           User      @relation(fields: [userId], references: [id])
  userId         String
  bolao          Bolao     @relation(fields: [bolaoId], references: [id])
  bolaoId        String
  numbers        Int[]
  isSurprise     Boolean   @default(false)
  createdAt      DateTime  @default(now())
  transparency   TransparencyFile? @relation(fields: [transparencyId], references: [id])
  transparencyId String?
}

model TransparencyFile {
  id        String   @id @default(cuid())
  bolao     Bolao    @relation(fields: [bolaoId], references: [id])
  bolaoId   String   @unique
  filePath  String
  createdAt DateTime @default(now())
  bets      Bet[]
}

model Payment {
  id          String        @id @default(cuid())
  user        User          @relation(fields: [userId], references: [id])
  userId      String
  amount      Decimal       @db.Decimal(12, 2)
  type        PaymentType
  status      PaymentStatus @default(PENDING)
  metadata    Json?
  createdAt   DateTime      @default(now())
  processedAt DateTime?
  approvedBy  String?
}

model Referral {
  id             String   @id @default(cuid())
  user           User     @relation("UserReferrals", fields: [userId], references: [id])
  userId         String
  referredUser   User     @relation("UserInvited", fields: [referredUserId], references: [id])
  referredUserId String   @unique
  level          Int
  createdAt      DateTime @default(now())
}

model AuditLog {
  id        String   @id @default(cuid())
  user      User?    @relation(fields: [userId], references: [id])
  userId    String?
  action    String
  details   Json?
  createdAt DateTime @default(now())
}
